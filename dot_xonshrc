# XONSH WEBCONFIG START
# XONSH WEBCONFIG END

# Standard imports
import time
import json
import platform
import os
from prompt_toolkit.keys import Keys

source ~/.config/xonsh/job.py
$PROMPT_FIELDS["current_job"] = CurrentJobField()

# xontribs
$XONSH_CAPTURE_ALWAYS=True # Required for output_search
$fzf_history_binding = Keys.ControlR
xontrib load direnv
xontrib load output_search
xontrib load fzf-widgets

$VI_MODE = True
$CASE_SENSITIVE_COMPLETIONS = False
# Use bash completions, we shall add more
$BASH_COMPLETIONS.insert(0,"/run/current-system/sw/share/bash-completion/bash_completion")

# Starship prompt
execx($(starship init xonsh))

# Import which function
from shutil import which

# Set shell to xonsh (We're going to spawn a new shell)
$SHELL = which("xonsh")
$EDITOR = "vim"
$VISUAL = "vim"

aliases["ls"] = "exa -lah"

# If ZELLIJ env var exists we don't wanna spawn it again
if "ZELLIJ" in ${...}:
  pass
# If zellij exists, ask if we wanna launch it
elif which("zellij") is not None:
  if input("Wanna launch Zellij? Y/n: ") != "n":
    # Attach to default session if it exists
    if $(zellij list-sessions 2> /dev/null | grep default):
      zellij attach default
    else:
      # Spawn new default session
      zellij -s default

    quit # Quit after Zellij has finished executing

# https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html#variables
if "XDG_CACHE_HOME" not in ${...}:
  $XDG_CACHE_HOME = $HOME/.cache
if "XDG_CONFIG_HOME" not in ${...}:
  $XDG_CONFIG_HOME = $HOME/.config
if "XDG_BIN_HOME" not in ${...}:
  $XDG_BIN_HOME = $HOME/.local/bin
if "XDG_DATA_HOME" not in ${...}:
  $XDG_DATA_HOME = $HOME/.local/share
if "XDG_STATE_HOME" not in ${...}:
  $XDG_STATE_HOME = $HOME/.local/state
if "NODE_HOME" not in ${...}:
  $XDG_STATE_HOME = $HOME/.local/node

# Add XDG_BIN_HOME to $PATH
$PATH.add($XDG_BIN_HOME)

# Add note stuff to $PATH
$PATH.add($NODE_HOME)
$NODE_PATH=$NODE_HOME+"/lib/node_modules"

# McFly configuration
$MCFLY_INTERFACE_VIEW="BOTTOM"
$MCFLY_RESULTS_SORT="LAST_RUN"

def bluemic():
    pactl set-card-profile $(pactl list cards short | grep bluez |  awk '{ print $1 }') headset-head-unit

def bluesound():
    pactl set-card-profile $(pactl list cards short | grep bluez |  awk '{ print $1 }') a2dp-sink

# If keychain binary exists, load ed25519 key
if which("keychain"):
  keychain -q id_ed25519
  if os.uname()[1] == "nub":
    keychain -q ed_viaplay
    keychain -q rsa_viaplay

aliases["vim"] = "nvim"

def _tfswitch(args, stdin=None):
  /usr/bin/env tfswitch -b $XDG_BIN_HOME/terraform @(args)

aliases["tfswitch"] = _tfswitch

def _blueprofile(args, stdin=None):
  profile = None

  card: str = $(pactl list cards short | grep bluez | awk '{print $1 }')

  if args[0] == "mic":
    profile = "headset-head-unit"
  elif args[0] == "music":
    profile = "a2dp-sink"

  if len(card) <= 0:
    print("Found no suitable bluetooth \"card\"")
    profile = None

  if profile:
    print("Switching profile")
    pactl set-card-profile @(card) @(profile)
    if profile == "headset-head-unit":
      pactl set-default-source $(pactl list sources short | rg bluez_input | awk '{ print $1 }') # Switch this when switching from bluetooth too

aliases["blueprofile"] = _blueprofile
